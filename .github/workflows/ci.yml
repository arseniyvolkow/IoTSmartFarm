name: SmartFarm CI

# –¢—Ä–∏–≥–≥–µ—Ä—ã: –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫–∏ main/master –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-service:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # –ï—Å–ª–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å —É–ø–∞–ª, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
      matrix:
        # –ü–µ—Ä–µ—á–∏—Å–ª—è–µ–º –ø–∞–ø–∫–∏ —Ç–≤–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        service: [user_service, farm_management_service, sensor_data_service, rule_service, rule_worker]

    # –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (Service Containers)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # –ñ–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pytest-asyncio httpx
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã
        if [ -f ${{ matrix.service }}/requirements.txt ]; then
          pip install -r ${{ matrix.service }}/requirements.txt
        else
          echo "‚ö†Ô∏è WARNING: No requirements.txt found in ${{ matrix.service }}"
        fi

    - name: Lint with Flake8
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ E501, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞)
        flake8 ${{ matrix.service }} --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 ${{ matrix.service }} --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Tests
      # –ó–∞–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã —Ç–µ—Å—Ç—ã –º–æ–≥–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–æ–≤—ã–º –ë–î
      env:
        POSTGRES_USER: test_user
        POSTGRES_PASSWORD: test_password
        POSTGRES_DB: test_db
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        SECRET_KEY: "test_secret_key" # –î–ª—è —Ç–µ—Å—Ç–æ–≤ JWT
        ALGORITHM: "HS256"
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞–ø–∫–∞ tests –∏–ª–∏ —Ñ–∞–π–ª—ã test_*.py
        if [ -d "${{ matrix.service }}/tests" ] || ls ${{ matrix.service }} | grep -q "test_"; then
           echo "üöÄ Running tests for ${{ matrix.service }}..."
           # –ó–∞–ø—É—Å–∫–∞–µ–º pytest –≤–Ω—É—Ç—Ä–∏ –ø–∞–ø–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
           pytest ${{ matrix.service }}
        else
           echo "‚ö†Ô∏è No tests found for ${{ matrix.service }}, skipping..."
        fi